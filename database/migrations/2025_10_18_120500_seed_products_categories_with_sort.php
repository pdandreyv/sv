<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;

class SeedProductsCategoriesWithSort extends Migration
{
    public function up()
    {
        // 1) Добавляем колонку sort (если её ещё нет)
        Schema::table('products__categories', function (Blueprint $table) {
            if (!Schema::hasColumn('products__categories', 'sort')) {
                $table->integer('sort')->default(0)->index();
            }
        });

        // 2) Полная очистка связанных таблиц в корректном порядке
        // Вначале удаляем зависимые записи, затем категории
        DB::table('resources_users')->delete();
        DB::statement('ALTER TABLE resources_users AUTO_INCREMENT = 1');
        DB::table('resources')->delete();
        DB::statement('ALTER TABLE resources AUTO_INCREMENT = 1');
        DB::table('products__products')->update(['category_id' => null]);
        DB::table('products__categories')->delete();
        DB::statement('ALTER TABLE products__categories AUTO_INCREMENT = 1');

        // 3) Подготовка данных
        $productCategories = [
            [
                'title' => 'Овощи, фрукты, орехи', 'for_service' => 0,
                'children' => [
                    'овощи свежие',
                    'овощи замороженные',
                    'фрукты свежие',
                    'ягоды свежие',
                    'сушёные и замороженные фрукты и ягоды',
                    'пастила',
                    'орехи',
                ],
            ],
            [
                'title' => 'Хлебобулочные изделия', 'for_service' => 0,
                'children' => [
                    'хлеб, булки, лаваш',
                    'печенье, бублики, сухари',
                    'безглютеновая выпечка',
                ],
            ],
            [
                'title' => 'Молочные продукты и яйца', 'for_service' => 0,
                'children' => [
                    'молоко',
                    'йогурты, кефир, сыворотка',
                    'сыры',
                    'творог',
                    'яйца',
                ],
            ],
            [
                'title' => 'Мясо, птица, рыба', 'for_service' => 0,
                'children' => [
                    'говядина',
                    'свинина',
                    'курица и другая птица',
                    'баранина и другие виды',
                    'морская рыба',
                    'пресноводная рыба',
                    'креветки, кальмары, мидии',
                ],
            ],
            [
                'title' => 'Напитки, чай, кофе', 'for_service' => 0,
                'children' => [
                    'вода (столовая, минеральная)',
                    'квасы, компоты',
                    'соки',
                    'напитки газированные',
                    'чаи, кофе и другие',
                ],
            ],
            [
                'title' => 'Жиры и масла', 'for_service' => 0,
                'children' => [
                    'растительные масла',
                    'сливочное масло',
                    'маргарин',
                    'спреды',
                ],
            ],
            [
                'title' => 'Сладости и десерты', 'for_service' => 0,
                'children' => [
                    'шоколад, конфеты',
                    'печенье, вафли',
                    'мороженое',
                    'торты, пирожные, десерты',
                ],
            ],
            [
                'title' => 'Бакалея, консервы, специи', 'for_service' => 0,
                'children' => [
                    'крупы, зерна, злаки',
                    'мука, макароны',
                    'соль, сахар',
                    'овощные консервы',
                    'рыбные/мясные консервы',
                    'соленья, квашеные овощи',
                    'соусы, кетчуп, горчица',
                    'специи',
                ],
            ],
            [
                'title' => 'Закуски, снеки', 'for_service' => 0,
                'children' => [
                    'чипсы, снеки, сухарики',
                    'орехи, семена',
                    'крекеры, сухофрукты',
                ],
            ],
            [
                'title' => 'Готовые блюда / полуфабрикаты', 'for_service' => 0,
                'children' => [
                    'замороженные готовые блюда',
                    'полуфабрикаты (котлеты, пельмени и др.)',
                    'супы, каши быстрого приготовления',
                ],
            ],
            [
                'title' => 'Диетические / здоровое питание', 'for_service' => 0,
                'children' => [
                    'безглютеновые',
                    'органические',
                    'спортивное питание',
                    'продукты с “дополнениями” (пробиотики, витамины)',
                ],
            ],
            [
                'title' => 'Прочее / сопутствующие', 'for_service' => 0,
                'children' => [
                    'корма для животных',
                    'пищевые добавки',
                ],
            ],
        ];

        $serviceCategories = [
            ['title' => 'Ремонт и обслуживание техники', 'for_service' => 1, 'children' => [
                'ремонт компьютеров, ноутбуков, смартфонов',
                'обслуживание бытовой техники (холодильники, стиральные машины)',
                'ремонт электроники, аудио и видео техники',
                'услуги по настройке и переустановке программного обеспечения',
            ]],
            ['title' => 'Домашние и бытовые услуги', 'for_service' => 1, 'children' => [
                'уборка квартир и домов',
                'химчистка, стирка, глажка',
                'сантехнические услуги, электрика',
                'ремонт и отделка помещений',
                'ландшафтный дизайн, садоводство',
            ]],
            ['title' => 'Красота и здоровье', 'for_service' => 1, 'children' => [
                'парикмахерские услуги, стрижки, укладки',
                'маникюр, педикюр, косметология',
                'массаж, спа услуги',
                'фитнес, йога, тренировки',
                'медицинские услуги, стоматология, терапия',
            ]],
            ['title' => 'Авто и транспортные услуги', 'for_service' => 1, 'children' => [
                'автомойка, детейлинг',
                'ремонт и обслуживание автомобилей',
                'эвакуация, доставка запчастей',
                'такси, аренда авто',
                'грузоперевозки, курьерская доставка',
            ]],
            ['title' => 'Образование и консультации', 'for_service' => 1, 'children' => [
                'репетиторство, языковые курсы',
                'профессиональное обучение, мастер классы',
                'бизнес консалтинг, юридические услуги',
                'психологическая помощь, коучинг',
            ]],
            ['title' => 'IT услуги и цифровой маркетинг', 'for_service' => 1, 'children' => [
                'веб дизайн, разработка сайтов',
                'SEO, контент маркетинг, SMM',
                'настройка серверов, DevOps',
                'создание приложений, UX UI дизайн',
            ]],
            ['title' => 'Организация мероприятий и досуг', 'for_service' => 1, 'children' => [
                'организация свадеб, корпоративов',
                'аренда оборудования, декор',
                'туристические и экскурсионные услуги',
                'развлечения, анимация, шоу программы',
            ]],
            ['title' => 'Финансы, страхование и недвижимость', 'for_service' => 1, 'children' => [
                'бухгалтерские услуги, аудит',
                'ипотека, кредитование, страхование',
                'оценка и продажа недвижимости',
                'инвестиционные и финансовые консультации',
            ]],
            ['title' => 'Логистика, склад и упаковка', 'for_service' => 1, 'children' => [
                'услуги складирования',
                'упаковка и переупаковка товаров',
                'фулфилмент, комплектация заказов',
                'доставка',
            ]],
            ['title' => 'Креативные и медиа услуги', 'for_service' => 1, 'children' => [
                'фотография, видеосъемка, монтаж',
                'графический дизайн, брендинг',
                'производство рекламы и подкастов',
                'озвучка, дикторские услуги',
            ]],
            ['title' => 'Услуги по уходу и помощи', 'for_service' => 1, 'children' => [
                'уход за пожилыми',
                'няни, сиделки, помощники',
                'услуги для животных (выгул, груминг)',
            ]],
            ['title' => 'Строительные и ремонтные услуги', 'for_service' => 1, 'children' => [
                'стройка домов, кладка кирпича',
                'кровельные работы',
                'бетонные работы',
                'земельные работы',
                'ремонтные работы',
            ]],
        ];

        // 4) Подготовка описаний для подкатегорий (только для товарных категорий)
        $subcategoryDescriptions = [
            // Овощи, фрукты, орехи
            'овощи свежие' => 'картофель, морковь, лук, помидоры, огурцы, капуста, перец, кабачки, баклажаны, свёкла, чеснок, сельдерей, укроп, петрушка, шпинат, салат',
            'овощи замороженные' => 'смесь овощная, брокколи, цветная капуста, фасоль стручковая, горошек, кукуруза, шпинат, грибы, перец, овощи для супа, рататуй, брюссельская капуста, морковь кубиками, картофель дольки, кабачок кубики',
            'фрукты свежие' => 'яблоки, бананы, апельсины, мандарины, груши, виноград, лимоны, киви, персики, нектарины, сливы, гранаты, грейпфруты, манго, авокадо',
            'ягоды свежие' => 'клубника, малина, черника, голубика, ежевика, смородина, крыжовник, вишня, черешня, земляника, брусника, облепиха, клюква, арбуз, дыня',
            'сушёные и замороженные фрукты и ягоды' => 'курага, изюм, чернослив, финики, сушёные яблоки, сушёные груши, сушёная клюква, сушёная вишня, сушёная клубника, сушёная черника, замороженная клубника, замороженная малина, замороженная черника, замороженная смесь ягод, цукаты',
            'пастила' => 'пастила яблочная, пастила ягодная, пастила без сахара, пастила с орехами, зефир, фруктовые рулеты, мармелад натуральный, пастила в шоколаде, пастила с ванилью, пастила с корицей',
            'орехи' => 'грецкий орех, миндаль, фундук, кешью, фисташки, арахис, кедровые орехи, макадамия, пекан, бразильский орех, смесь орехов, орехи солёные, орехи жареные, орехи в мёде, ореховая паста',

            // хлебобулочные изделия
            'хлеб, булки, лаваш' => 'хлеб пшеничный, хлеб ржаной, батон, чиабатта, лаваш, багет, бублики, булочки, хлеб цельнозерновой, хлеб бездрожжевой, лепёшка, фокачча, тостовый хлеб, бородинский, хлеб с семенами',
            'печенье, бублики, сухари' => 'печенье сахарное, печенье овсяное, печенье с начинкой, крекеры, баранки, бублики, сухари ванильные, сухари ржаные, галеты, пряники, имбирное печенье, печенье без сахара, крекеры цельнозерновые, бретцели, сушки',
            'безглютеновая выпечка' => 'хлеб без глютена, кексы без глютена, печенье без глютена, брауни без глютена, маффины без глютена, лепёшки без глютена, вафли без глютена, смесь для хлеба без глютена, тортики без глютена',

            // Молочные продукты и яйца
            'молоко' => 'молоко пастеризованное, молоко ультрапастеризованное, молоко безлактозное, молоко козье, молоко топлёное, молоко 1.5%, молоко 3.2%, молоко деревенское, молоко органическое',
            'йогурты, кефир, сыворотка' => 'йогурт натуральный, йогурт греческий, йогурт питьевой, кефир классический, кефир обезжиренный, ряженка, простокваша, сыворотка молочная, ацидофилин, биойогурт, айран',
            'сыры' => 'сыр твёрдый, сыр полутвёрдый, моцарелла, пармезан, гауда, чеддер, брынза, фета, сулугуни, маскарпоне, рикотта, дорблю, камамбер, эмменталь, тофу',
            'творог' => 'творог 5%, творог 9%, творог обезжиренный, творожная масса, зернёный творог, творог домашний, сырники, паста творожная, творог детский, творог с изюмом',
            'яйца' => 'яйца куриные, яйца перепелиные, яйца диетические, яйца отборные, яйца органические, яйца С0, яйца С1, яйца С2',

            // Мясо, птица, рыба
            'говядина' => 'лопатка, грудинка, вырезка, антрекот, стейк, фарш говяжий, ребра, оковалок, язык говяжий, печень говяжья, стейк рибай, гуляш, шея, пашина, хвосты',
            'свинина' => 'корейка, шея, окорок, рёбра, вырезка, фарш свиной, грудинка, отбивные, лопатка, печень свиная, бекон, карбонат, сало, стейк, голень',
            'курица и другая птица' => 'куриное филе, бедро, голень, крылья, тушка, индейка филе, индейка бедро, утка, гусь, субпродукты куриные, печень куриная, сердечки куриные, фарш из птицы, грудка индейки, крыло индейки',
            'баранина и другие виды' => 'баранина лопатка, баранина нога, каре, шея, фарш бараний, кости для бульона, козлятина, кролик, оленьина, конина',
            'морская рыба' => 'лосось, треска, хек, сайда, пикша, тунец, скумбрия, сельдь, дорадо, сибас, палтус, минтай, камбала, мерлуза, макрурус',
            'пресноводная рыба' => 'карп, карась, щука, судак, окунь, сом, форель речная, налим, лещ, жерех, белорыбица, толстолобик, пелядь, голец, линь',
            'креветки, кальмары, мидии' => 'креветки очищенные, креветки в панцире, кальмары тушки, кальмары кольца, мидии варёные, мидии в раковине, коктейль морепродуктов, осьминоги, рапаны, креветки тигровые, креветки королевские, гребешок, устрицы, креветки северные',

            // Напитки, чай, кофе
            'вода (столовая, минеральная)' => 'вода негазированная, вода газированная, минеральная вода, вода детская, вода спортивная, вода стекло, вода 5 л, вода 1.5 л, вода 0.5 л, вода лечебная',
            'квасы, компоты' => 'квас живой, квас хлебный, компот вишнёвый, компот яблочный, компот ягодный, морс клюквенный, морс брусничный, узвар, сбитень',
            'соки' => 'сок яблочный, апельсиновый, томатный, мультифрукт, персиковый, вишнёвый, ананасовый, виноградный, морковный, гранатовый, манговый, грушевая нектар, морс',
            'напитки газированные' => 'кола, лимонад, тархун, байкал, газировка без сахара, тоник, энергетик, спрайт, фанта, имбирный эль, крем-сода, дюшес',
            'чаи, кофе и другие' => 'чай чёрный, чай зелёный, чай травяной, чай улун, кофе зерновой, кофе молотый, кофе растворимый, капсулы кофе, цикорий, какао, матча, ройбуш, каркаде',

            // Жиры и масла
            'растительные масла' => 'подсолнечное масло, оливковое масло, льняное масло, кукурузное масло, арахисовое масло, тыквенное масло, кунжутное масло, рапсовое масло, кокосовое масло, масло виноградной косточки, горчичное масло',
            'сливочное масло' => 'масло 82.5%, масло 72.5%, масло крестьянское, масло топлёное, масло фермерское, масло безлактозное, масло с солью, масло несолёное',
            'маргарин' => 'маргарин для выпечки, маргарин столовый, маргарин сливочный, кулинарный жир, смесь для кремов',
            'спреды' => 'спред сливочно-растительный, спред бутербродный, продукт маслосодержащий, крем-спред, паста масляная',

            // Сладости и десерты
            'шоколад, конфеты' => 'плиточный шоколад, шоколад горький, шоколад молочный, шоколад белый, конфеты ассорти, трюфели, карамель, ирис, шоколад без сахара, батончики',
            'печенье, вафли' => 'вафли, печенье песочное, печенье с начинкой, сендвич печенье, крекер сладкий, печенье диетическое, вафли шоколадные, трубочки вафельные, рулеты бисквитные, курабье',
            'мороженое' => 'мороженое пломбир, эскимо, стаканчик, рожок, брикет, сорбет, замороженный йогурт, санди, фисташковое мороженое, шоколадное мороженое, ванильное мороженое',
            'торты, пирожные, десерты' => 'медовик, наполеон, чизкейк, тирамису, эклеры, профитроли, пирожные картошка, бисквитные пироги, рулеты, суфле, пирожные слоёные, трайфл',

            // Бакалея, консервы, специи
            'крупы, зерна, злаки' => 'рис, гречка, овсянка, перловка, булгур, киноа, кускус, пшено, ячка, кукурузная крупа, манка, горох, чечевица, нут, полба',
            'мука, макароны' => 'мука пшеничная, мука ржаная, мука кукурузная, мука цельнозерновая, макароны спагетти, макароны пенне, рожки, лапша, феттуччине, макароны безглютеновые, мука миндальная',
            'соль, сахар' => 'сахар белый, сахар тростниковый, соль каменная, соль морская, соль йодированная, сахар-песок, пудра сахарная, заменитель сахара, сироп агавы, стевия',
            'овощные консервы' => 'огурцы консервированные, помидоры консервированные, кукуруза консервированная, горошек консервированный, лечо, фасоль консервированная, баклажаны, кабачки, аджика',
            'рыбные/мясные консервы' => 'тунец консервированный, сардины, шпроты, сайра, печень трески, говядина тушёная, свинина тушёная, паштеты мясные, паштеты рыбные, курица в собственном соку',
            'соленья, квашеные овощи' => 'квашеная капуста, солёные огурцы, солёные помидоры, мочёные яблоки, кимчи, ассорти солёное, чеснок маринованный, перец маринованный',
            'соусы, кетчуп, горчица' => 'кетчуп, майонез, горчица, соевый соус, барбекю соус, терияки, песто, сацебели, ткемали, аджика, хумус',
            'специи' => 'чёрный перец, паприка, карри, куркума, кориандр, кумин, базилик, орегано, тимьян, розмарин, лавровый лист, гвоздика, корица, имбирь',

            // Закуски, снеки
            'чипсы, снеки, сухарики' => 'чипсы картофельные, снеки кукурузные, начос, сухарики ржаные, сухарики пшеничные, палочки солёные, попкорн, палочки сырные, орешки в глазури, кальмары сушёные',
            'орехи, семена' => 'семечки подсолнечника, семена тыквы, арахис солёный, миндаль солёный, кешью солёный, смесь орехов и семян, семена чиа, кунжут, лен семена, микс тропический',
            'крекеры, сухофрукты' => 'крекеры солёные, крекеры сырные, крендельки, сухофрукты ассорти, финики сушёные, инжир сушёный, абрикос сушёный, манго сушёное, яблоки сушёные',

            // Готовые блюда / полуфабрикаты
            'замороженные готовые блюда' => 'пицца замороженная, лазанья, овощные смеси готовые, котлеты готовые, наггетсы, рыбные палочки, шаурма, блинчики, вареники, запеканка, картофель по-деревенски',
            'полуфабрикаты (котлеты, пельмени и др.)' => 'пельмени, котлеты, фаршированные перцы, голубцы, бифштексы, люля-кебаб, котлета по-киевски, наггетсы куриные, манты, хинкали, чебуреки, сырники заморозка',
            'супы, каши быстрого приготовления' => 'суп лапша быстр., суп пюре, суп мисо, каша овсяная быстр., каша гречневая быстр., пюре картофельное, лапша быстрого приготовления, булгур быстр., рис быстр., борщ концентрат',

            // Диетические / здоровое питание / функциональное питание
            'безглютеновые' => 'хлеб без глютена, печенье без глютена, макароны без глютена, хлопья без глютена, мука без глютена, смеси без глютена, батончики без глютена, вафли без глютена',
            'органические' => 'овощи органические, фрукты органические, молоко органическое, яйца органические, крупы органические, масло органическое, мясо органическое, мука органическая',
            'спортивное питание' => 'протеин, гейнер, BCAA, креатин, батончики протеиновые, предтренировочные комплексы, изотоники, L-карнитин, омега-3, витаминные комплексы, электролиты',
            'продукты с “дополнениями” (пробиотики, витамины)' => 'йогурт с пробиотиками, кефир с пробиотиками, сок с витаминами, батончики с витаминами, хлеб с клетчаткой, напитки функциональные, фортированные каши, продукты с омега-3',

            // Прочее / сопутствующие
            'корма для животных' => 'корм для кошек, корм для собак, лакомства для кошек, лакомства для собак, наполнитель, консервы для кошек, консервы для собак, сухой корм, влажный корм, витамины для животных',
            'пищевые добавки' => 'витамин C, витамин D, магний, кальций, омега-3, пробиотики, мультивитамины, железо, цинк, коллаген, коэнзим Q10, L-карнитин',
        ];

        // 5) Вставка данных с заполнением описаний и сортировок
        $insertCategoryTree = function (array $groups, int $startSort, int $forServiceDefault) use ($subcategoryDescriptions) {
            $rootSort = $startSort;
            foreach ($groups as $group) {
                $children = $group['children'] ?? [];
                $description = implode(', ', $children);
                $rootId = DB::table('products__categories')->insertGetId([
                    'title' => $group['title'],
                    'description' => $description ?: null,
                    'photo' => null,
                    'icon' => null,
                    'parent_id' => null,
                    'for_service' => $group['for_service'] ?? $forServiceDefault,
                    'sort' => $rootSort,
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);

                $childSort = 1;
                foreach ($children as $childTitle) {
                    DB::table('products__categories')->insert([
                        'title' => $childTitle,
                        'description' => $forServiceDefault === 0 && isset($subcategoryDescriptions[$childTitle]) ? $subcategoryDescriptions[$childTitle] : null,
                        'photo' => null,
                        'icon' => null,
                        'parent_id' => $rootId,
                        'for_service' => $group['for_service'] ?? $forServiceDefault,
                        'sort' => $childSort,
                        'created_at' => now(),
                        'updated_at' => now(),
                    ]);
                    $childSort++;
                }

                $rootSort += 10; // шаг для будущих вставок между группами
            }
        };

        $insertCategoryTree($productCategories, 10, 0);
        $insertCategoryTree($serviceCategories, 1000, 1);
    }

    public function down()
    {
        // Возврат к состоянию до этой миграции: удаляем все новые записи и удаляем колонку sort
        DB::table('products__categories')->delete();
        DB::statement('ALTER TABLE products__categories AUTO_INCREMENT = 1');

        Schema::table('products__categories', function (Blueprint $table) {
            if (Schema::hasColumn('products__categories', 'sort')) {
                $table->dropIndex(['sort']);
                $table->dropColumn('sort');
            }
        });
    }
}

?>


