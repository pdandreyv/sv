tinymce.PluginManager.add('mylink', function (editor) {
    editor.addCommand('insertMyLink', function () {

        if ($('.tox-pop--bottom').length) {
            console.log('bottom');
            $('.tox-pop--bottom').hide();
            $('#tiny_link_dialog').css('top', 'initial');
            $('#tiny_link_dialog').css('bottom', parseInt($('.tox-pop--bottom').css('bottom')) + 5);
            $('#tiny_link_dialog').css('left', parseInt($('.tox-pop--bottom').css('left')));
        }
        if ($('.tox-pop--top').length) {
            console.log('top');
            $('.tox-pop--top').hide();
            $('#tiny_link_dialog').css('bottom', 'initial');
            $('#tiny_link_dialog').css('top', parseInt($('.tox-pop--top').css('top')) + 5);
            $('#tiny_link_dialog').css('left', parseInt($('.tox-pop--bottom').css('left')));
        }
        if ($('.tox-pop--align-left').length) {
            console.log('left');
            $('.tox-pop--align-left').hide();
            $('#tiny_link_dialog').css('right', 'initial');
            $('#tiny_link_dialog').css('left', parseInt($('.tox-pop--align-left').css('left')));
        }
        if ($('.tox-pop--align-right').length) {
            console.log('right');
            $('.tox-pop--align-right').hide();
            $('#tiny_link_dialog').css('left', 'initial');
            $('#tiny_link_dialog').css('right', parseInt($('.tox-pop--align-right').css('right')));
        }
        $('#tiny_link_dialog').show();
        $('#tiny_link_dialog input').val('');
        $('#tiny_link_dialog input').focus();
        $('#tiny_link_dialog input').data('editor-id', editor.id);


        var selectedText = editor.selection.getContent();
        /*if(selectedText.indexOf('href')>-1) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(selectedText, 'text/html');
            var links = doc.querySelectorAll('a[href]');
            $('#tiny_link_dialog input').val(links[0].href);
        }*/
        var parser = new DOMParser();
        var doc = parser.parseFromString(editor.getContent(), 'text/html');
        var links = doc.querySelectorAll('a[href]');
        links.forEach(function (link) {
            selectedText = selectedText.replace(/<\/?[^>]+(>|$)/g, "").trim();
            if (selectedText == link.outerText.trim()) {
                $('#tiny_link_dialog input').val(link.href);
            }
        });
    });

    editor.ui.registry.addIcon('mylink', '<img src="/extentions/tinymce/icons/link.png" style="height: 40px;width: 40px;padding: 3px 0px 0px 0px;"/>');
    editor.ui.registry.addButton('mylink', {
        onAction: function () {
            editor.execCommand('insertMyLink');
        },
        icon: 'link'
    });

    return {
        getMetadata: function () {
            return {
                name: 'Link',
                url: ''
            };
        }
    };
});
